#!/bin/bash

CONFLUENCE_VERSION_DOT_FREE="6153"
CONFLUENCE_VERSION="6.15.3"

export CLICOLOR=1
C_RED='\x1B[31m'
C_CYN='\x1B[96m'
C_GRN='\x1B[32m'
C_MGN='\x1B[35m'
C_RST='\x1B[39m'


# Used to be able to use pass-by-reference in bash
#
#
return_by_reference() {
    if unset -v "$1"; then
        eval $1=\"\$2\"
    fi
}

# Kill and remove an existing named container
#
# @param $1 {string} the container name or part of it
function _kill_and_remove_named_instance_if_exists {
    container_name=$1
    # KILL
    named_container_running_result=-1
    _is_named_container_running ${container_name} named_container_running_result
    if (( named_container_running_result == 1 )) # arithmetic brackets ... woohoo
    then
        echo -e $C_CYN">> docker kill ........:${C_RST}${C_GRN} Killing${C_RST}   - Named container ${container_name} is running."
        docker kill ${container_name}
    else
        echo -e $C_CYN">> docker kill ........:${C_RST}${C_MGN} Skipping${C_RST}  - Named container ${container_name} is not running."
    fi
}

# Returns 1 if the container is running and 0 if not
#
# @usage `_is_named_container_running 'foo' $result` passed variable `result` contains return value
#
# @param $1 {string} name or name-chunk of container
# @param $2 {int} return value passByReference
function _is_named_container_running {
    local ret_value=$(docker ps --format '{{.ID}}' --filter "name=${1}" | wc -l | awk '{print $1}')

    local "$2" && return_by_reference $2 $ret_value
}

function kill_instance_database {
    _kill_and_remove_named_instance_if_exists confluence-cluster-${CONFLUENCE_VERSION_DOT_FREE}-db
}

function kill_instance_loadbalancer {
    _kill_and_remove_named_instance_if_exists confluence-cluster-${CONFLUENCE_VERSION_DOT_FREE}-lb
}

function kill_instance_confluencenode {
    _kill_and_remove_named_instance_if_exists confluence-cluster-${CONFLUENCE_VERSION_DOT_FREE}-node1
}


kill_instance_database
kill_instance_loadbalancer
kill_instance_confluencenode